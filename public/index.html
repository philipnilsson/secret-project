‚àè<html>

<head> <title> Tetris! </title>

    <script src="gl/glMatrix-0.9.5.min.js"></script>
    <script src="gl/shader-factory.js"></script>
    <script src="gl/renderer.js"></script>
    <script src="tetris-webgl.js"></script>

    <script id="shader-fs-any-color" type="x-shader/x-fragment">
        uniform highp vec4 uColor;
        void main(void) {
            gl_FragColor = uColor;
        }
    </script>

    <!-- Vertex shader program -->
    <script id="shader-vs" type="x-shader/x-vertex">
        attribute highp vec3 aVertexPosition;

        uniform highp mat4 uMVP;

        void main(void) {
            gl_Position = uMVP * vec4(aVertexPosition, 1.0);
        }
    </script>

    <style>
        #feedback { font-size: 1.4em; }
        #selectable .ui-selecting { background: #FECA40; }
        #selectable .ui-selected { background: #F39814; color: white; }
        #selectable { list-style-type: none; margin: 0; padding: 0; width: 60%; }
        #selectable li { margin: 3px; padding: 0.4em; font-size: 1.4em; height: 18px; width: 250px }
    </style>

</head>

<!-- JQUERY-->
<link rel="stylesheet" href="http://code.jquery.com/ui/1.10.3/themes/smoothness/jquery-ui.css" />
<script type="text/javascript" src="jquery.js"></script>
<script src="http://code.jquery.com/ui/1.10.3/jquery-ui.js"></script>

<link rel="stylesheet" type="text/css" href="tetris.css" />

<script type="text/javascript" src="bacon.js"></script>
<script type="text/javascript" src="drawing.js"></script>
<script>
    var Drawing2 = Drawing;
</script>
<script type="text/javascript" src="gldrawing.js"></script>
<script type="text/javascript" src="tetris.js"></script>
<script type="text/javascript" src="game.js"></script>
<script type="text/javascript" src="util.js"></script>

<script type="text/javascript" src="socket.io/socket.io.js"></script>

<script type="text/javascript">
    var w = 10, h = 20;
</script>

<body>
  <div id="menu"> 
    <button id="single"> Single-player </button>
    <button id="host"> New </button>
    <button id="join"> Join </button>
  </div>
  <div id="waitingroom"> </div>
  <div id="rooms"> </div>
  
  <div id="game1"></div>
  <div id="game2"></div>
  <div id="chat"> </div>

  <div id="test menu" style="display: none">
      Global Alpha
      <div id="slider" style="width:100px;"></div>

      <ol id="selectable">
          <li>Add Mode</li>
          <li>Edit Mode</li>
      </ol>

      <button id="gblocks">Generate Blocks</button>
  </div>




</body>

<script>

$('#single').on('click', function() {
    // TEST =======================================
    var DEBUG = true;
    globalAlpha = 1;
    // ============================================

    var inputs = keyInputs();

    var drawing = new Drawing($('#game1'));
    var events = tetris(drawing, inputs, false);
    tetris(new Drawing2($('#game2')), events, true);

    // hide start menu
    document.getElementById('menu').style.display = 'none';

    if(DEBUG) {
        // TODO check for debug..
        // show menu..
        document.getElementById('test menu').style.display = 'inline';

        function onSlide(event, ui) {
            console.log("on slide: " + ui.value);
            globalAlpha = ui.value;
            drawing.forceDraw();
        }

        $("#gblocks").on('click', function() {
            drawing.generateRandomBlocks();
        });

        var mode = undefined;

        function modeIsSelected(event, ui) {
            switch(ui.selecting.innerText) {
                case "Add Mode":
                    mode = "addMode";
                    break;
                case "Edit Mode":
                    mode = "editMode";
                    break;
            }
        }

        drawing.canvas.onclick = function(event) {
            var i = Math.floor((event.offsetX / drawing.canvas.width) * 10);
            var j = Math.floor((event.offsetY / drawing.canvas.height) * 20);

            switch(mode) {
                case "addMode":
                    drawing.board.addBlockAt(i, j);
                    break ;
                case "editMode":
//                    board.getBlockAt();
                    break;
            }
        };

        $(function() {
            $( "#slider" ).slider({max : 1, min : 0, step : 0.1, value : 1, slide : onSlide});
        });

        $(function() {
            $( "#selectable" ).selectable({selecting : modeIsSelected});
        });
    }

});

var messages = [];
var socket     = io.connect('http://192.168.43.47:3700');
var field      = $("#field");
var sendButton = $("#send");
var content    = $("#content");
var name       = $("#name");
var socketId   = undefined;

socket.on('message', function(data) {
  socketId = data.id;
  console.log('my socket id', socketId)
  $('#chat').append('<div>' + data.message + '</div>');
})

$('#host').click(function() {
  socket.emit('host');
})
$('#join').click(function() {
  socket.emit('list rooms');
})

var $rooms = $('#rooms');
var $gameRoom = $('#waitingroom');

socket.on('rooms', function(x) {
  $rooms.show();
  $rooms.html('')
  $gameRoom.hide();
  var any = false;
  for (var i in x) {
    if(i.indexOf('/') >= 0) {
      any = true;
      room = $('<div>' + i + ', #players: ' + (x[i].length || 0) + ' <button class="join" data-room="' + i + '">Join</button></div>');
      room.find('button').click(function(e) {
          socket.emit('join', $(e.target).attr('data-room'))
      });
      $rooms.append(room)
    }
  }
  if (!any)
    $rooms.append('no games found')
});

socket.on('joined', function(data) {
  $rooms.hide();
  $gameRoom.show();
  $gameRoom.html('');
  for (var i in data.players) {
      $gameRoom.append('<div>' + data.players[i] + '</div>')
  }
  var start = $('<button> Start </button>')
  start.click(function() {
      socket.emit('startGame')
  });
  $gameRoom.append(start);
});

function hasKey(key) {
    return function(obj) { return key in obj }
}

function gameEvents(socket, otherId) {
    var bus = new Bacon.Bus();
    var buffer = []
    var i = 0;
    socket.on('gameEvent', function(data) {
        buffer.push(data);
        buffer.sort(function(x) { return x.i })
        while (buffer.length > 0 && buffer[0].i <= i) {
            bus.push(buffer.shift())
            i++;
        }
    });
    return bus;
}

function parseGEs(gameEvents) {
    var inputs = inputsFromSocket(gameEvents);
    var blocks = gameEvents.filter(hasKey('id'));
    inputs.block = blocks.map('.block');
    return inputs;
}

function inputsFromSocket(gameEvents) {
    var input = gameEvents
        .filter(hasKey('keyEvent'))
        .map('.keyEvent');

    return {
        ups: input.filter(eq('ups')),
        downs: input.filter(eq('downs')),
        lefts: input.filter(eq('lefts')),
        rights: input.filter(eq('rights')),
        ts: input.filter(eq('ts')),
        space: input.filter(eq('space'))
    }
}

function blocksFromSocket(gameEvents, callback) {
    var blockEvents = gameEvents.filter(hasKey('id')).delay(1000)
    var buf = [];
    blockEvents.onValue(function(x) {
        buf.push(x.block);
    });
    
    return function() { 
        if (buf.length > 0) 
            return Bacon.once(blocks[buf.shift()]);

        return blockEvents.take(1).map(function(x) {
            return blocks[buf.shift()];
        });
    };
}

started = false;
socket.on('startTS', function(data) {
    data = data.filter(function(id) { return id !== socketId })
    $gameRoom.hide();
    if (!started) {
        started = true;
        var inputs = keyInputs();
        var events = tetris(new Drawing($('#game1')), inputs, false)
        events.withMeta(socketId).emit(socket, 'gameEvent');
    }
    var otherId = data[0];
    var events = gameEvents(socket, otherId)
    tetris(new Drawing($('#game2')), events, true);
})

socket.on('hosted', function(x) {
  $rooms.hide();
  $gameRoom.show();
  $gameRoom.html('');
  $gameRoom.append('waiting for players');
});

</script>

</html>

<html>

<head> <title> Tetris! </title> </head>

<link rel="stylesheet" type="text/css" href="tetris.css" />

<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="bacon.js"></script>
<script type="text/javascript" src="drawing.js"></script>
<script type="text/javascript" src="tetris.js"></script>
<script type="text/javascript" src="game.js"></script>
<script type="text/javascript" src="util.js"></script>

<script type="text/javascript" src="socket.io/socket.io.js"></script>

<script type="text/javascript">
  
var w = 10, h = 20;


</script>

<body>
  <div id="menu"> 
    <button id="host"> New </button>
    <button id="join"> Join </button>
  </div>
  <div id="waitingroom"> </div>
  <div id="rooms"> </div>
  
  <div id="game1"> </div> 
  <div id="game2"> </div> 
  <div id="chat"> </div>
  
</body>

<script>

var messages = [];
var socket = io.connect('http://localhost:3700');
var field = $("#field");
var sendButton = $("#send");
var content = $("#content");
var name = $("#name");
var socketId = undefined;

socket.on('message', function(data) {
  socketId = data.id;
  console.log('my socket id', socketId)
  $('#chat').append('<div>' + data.message + '</div>');
})

$('#host').click(function() {
  socket.emit('host');
})

$('#join').click(function() {
  socket.emit('list rooms');
})

var $rooms = $('#rooms');
var $gameRoom = $('#waitingroom');

socket.on('rooms', function(x) {
  $rooms.show();
  $rooms.html('')
  $gameRoom.hide();
  var any = false;
  for (var i in x) {
    if(i.indexOf('/') >= 0) {
      any = true;
      room = $('<div>' + i + ', #players: ' + (x[i].length || 0) + ' <button class="join" data-room="' + i + '">Join</button></div>');
      room.find('button').click(function(e) {
          socket.emit('join', $(e.target).attr('data-room'))
      });
      $rooms.append(room)
    }
  }
  if (!any)
    $rooms.append('no games found')
});

socket.on('joined', function(data) {
  $rooms.hide();
  $gameRoom.show();
  $gameRoom.html('');
  for (var i in data.players) {
      $gameRoom.append('<div>' + data.players[i] + '</div>')
  }
  var start = $('<button> Start </button>')
  start.click(function() {
      socket.emit('startGame')
  });
  $gameRoom.append(start);
});

function hasKey(key) {
    return function(obj) { return key in obj }
}

function gameEvents(socket, otherId) {
    var bus = new Bacon.Bus();
    var buffer = []
    var i = 0;
    socket.on('gameEvent', function(data) {
        buffer.push(data);
        buffer.sort(function(x) { return x.i })
        while (buffer.length > 0 && buffer[0].i <= i)
            bus.push(buffer.shift())
    });
    return bus;
}

function inputsFromSocket(gameEvents) {
    var input = gameEvents
        .filter(hasKey('keyEvent'))
        .map('.keyEvent');

    return {
        ups: input.filter(eq('ups')),
        downs: input.filter(eq('downs')),
        lefts: input.filter(eq('lefts')),
        rights: input.filter(eq('rights')),
        ts: input.filter(eq('ts')),
        space: input.filter(eq('space'))
    }
}

function provideBlock(socket) {
    var bus = new Bacon.Bus()
    bus.emit(socket, 'gameEvent');
    return function _provideBlock() {
      var randomBlock = Block.randomBlock()
      console.log('randomBlcok', randomBlock);
      bus.push({ block: randomBlock, id: socketId });
      return blocks[randomBlock];
    }
}

function blocksFromSocket(gameEvents, callback) {
    var block;
    var first = true;
    var blocks = gameEvents.filter(hasKey('id'))
    blocks.onValue(function(data) {
        block = data.block;
        if (first) 
            callback (function() { return blocks[block]; })
        first = false;
    });
    return function() { return block };
}

started = false;
socket.on('start', function(data) {
    data = data.filter(function(id) { return id !== socketId })
    $gameRoom.hide();
    if (!started) {
        started = true;
        var inputs = keyInputs();
        var blocks = tetris(new Drawing($('#game1')), inputs, provideBlock(socket))
        for (var k in inputs)
            inputs[k].map({keyEvent: k}).emit(socket, 'gameEvent');
    }
    var otherId = data[0];
    var otherInput = inputsFromSocket(socket, otherId)
    blocksFromSocket(socket, otherId, function(f) {
        tetris(new Drawing($('#game2')), otherInput, f);
    });
})

socket.on('hosted', function(x) {
  $rooms.hide();
  $gameRoom.show();
  $gameRoom.html('');
  $gameRoom.append('waiting for players');
});

</script>

</html>

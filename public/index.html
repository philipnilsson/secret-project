<html>

<head> <title> Tetris! </title> </head>

<link rel="stylesheet" type="text/css" href="tetris.css" />

<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="bacon.js"></script>
<script type="text/javascript" src="drawing.js"></script>
<script type="text/javascript" src="tetris.js"></script>

<script type="text/javascript" src="socket.io/socket.io.js"></script>

<script type="text/javascript">
  
var w = 10, h = 20;

function eq(x) {
  return function(y) { return x === y; };
}

function keyInputs() {
  var keys = $(document).asEventStream('keydown').map('.keyCode');
  return {
    ups: keys.filter(eq(38)),
    lefts: keys.filter(eq(37)),
    rights: keys.filter(eq(39)),
    downs: keys.filter(eq(40)),
    space: keys.filter(eq(32)),
    ts: Bacon.interval(200)
  }
}

  
function tetris(drawing, input) {
  
  drawing.drawGameArea(w, h);

  var board = new Board(10, 20);
   
  var game = function() {
   
    var init = new BlockState(Block.randomBlock(), board);
    
    if (init.collides()) {
      init.isSet = true;
      return Bacon.once(init);
    }

    var block = Bacon.update(
       init,
       [input.ups],    Block.move( 0, 0, 3),
       [input.downs],  Block.move( 0, 0, 1),
       [input.lefts],  Block.move(-1, 0, 0),
       [input.rights], Block.move( 1, 0, 0),
       [input.ts],     Block.move( 0, 1, 0),
       [input.space],  function(st) { return st.down(); }
    );

    return block
      .takeUntil(function(x) { return x.isSet; })
      .flatMapEnd(game);
  };
  
  var g = game()
  g.onValue(function (block) { 
    if (block.isSet) 
      drawing.setBlock(block, board.set(block));
    drawing.drawBlock(block); 
  });
  
  g.onEnd(function() {
    console.log('you dead');
  })
};

</script>

<body>
  <div id="game1"> </div> 
  <div id="game2"> </div> 
  <div id="chat"> </div>
</body>

<script>

var messages = [];
var socket = io.connect('http://localhost:3700');
var field = $("#field");
var sendButton = $("#send");
var content = $("#content");
var name = $("#name");

socket.on('message', function(data) {
  $('#chat').append('<div>' + data.message + '</div>');
})

$(function() {
  tetris(new Drawing($('#game1')), keyInputs())
  tetris(new Drawing($('#game2')), keyInputs())
})

</script>

</html>

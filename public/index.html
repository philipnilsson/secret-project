<html>

<head> <title> Tetris! </title> </head>

<link rel="stylesheet" type="text/css" href="tetris.css" />

<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="bacon.js"></script>
<script type="text/javascript" src="drawing.js"></script>
<script type="text/javascript" src="tetris.js"></script>
<script type="text/javascript" src="game.js"></script>
<script type="text/javascript" src="util.js"></script>

<script type="text/javascript" src="socket.io/socket.io.js"></script>

<script type="text/javascript">
  
var w = 10, h = 20;


</script>

<body>
  <div id="menu"> 
    <button id="host"> New </button>
    <button id="join"> Join </button>
  </div>
  <div id="waitingroom"> </div>
  <div id="rooms"> </div>
  
  <div id="game1"> </div> 
  <div id="game2"> </div> 
  <div id="chat"> </div>
  
</body>

<script>

var messages = [];
var socket = io.connect('http://localhost:3700');
var field = $("#field");
var sendButton = $("#send");
var content = $("#content");
var name = $("#name");
var socketId = undefined;

socket.on('message', function(data) {
  console.log(data.id);
  socketId = data.id;
  $('#chat').append('<div>' + data.message + '</div>');
})

$('#host').click(function() {
  socket.emit('host');
})

$('#join').click(function() {
  socket.emit('list rooms');
})

var $rooms = $('#rooms');
var $gameRoom = $('#waitingroom');

socket.on('rooms', function(x) {
  $rooms.show();
  $rooms.html('')
  $gameRoom.hide();
  var any = false;
  for (var i in x) {
    if(i.indexOf('/') >= 0) {
      any = true;
      room = $('<div>' + i + ', #players: ' + (x[i].length || 0) + ' <button class="join" data-room="' + i + '">Join</button></div>');
      room.find('button').click(function(e) {
          socket.emit('join', $(e.target).attr('data-room'))
      });
      $rooms.append(room)
    }
  }
  if (!any)
    $rooms.append('no games found')
});

socket.on('joined', function(data) {
  $rooms.hide();
  $gameRoom.show();
  $gameRoom.html('');
  for (var i in data.players) {
      $gameRoom.append('<div>' + data.players[i] + '</div>')
  }
  var start = $('<button> Start </button>')
  start.click(function() {
      socket.emit('startGame')
  });
  $gameRoom.append(start);
});

function inputsFromSocket(socket, otherId) {
    function input(name) {
        return Bacon.fromIO(socket, name).filter(function(id) {
            return id === otherId;
        })
    }
    return {
        ups: input('ups'),
        downs: input('downs'),
        lefts: input('downs'),
        rights: input('rights'),
        ts: input('ts'),
        space: input('spce')
    }
}

started = false;
socket.on('start', function(data) {
    data = data.filter(function(id) { return id !== socketId })
    console.log(data);
    $gameRoom.hide();
    if (!started) {
        started = true;
        var inputs = keyInputs();
        var g = tetris(new Drawing($('#game1')), inputs)
        for (var k in inputs)
            inputs[k].emit(socket, k);
    }
    var otherId = data[0];
    var otherInput = inputsFromSocket(socket, otherId)
    for (var s in otherInput)
        otherInput[s].log('other ' + s);
})

socket.on('hosted', function(x) {
  $rooms.hide();
  $gameRoom.show();
  $gameRoom.html('');
  $gameRoom.append('waiting for players');
});
 
$(function() {
  // tetris(new Drawing($('#game1')), keyInputs())
  // tetris(new Drawing($('#game2')), keyInputs())
})

</script>

</html>
